# Module Qu·∫£n l√Ω S√°ch (Books)

## üìë T·ªïng quan

Module Qu·∫£n l√Ω S√°ch cung c·∫•p c√°c API ƒë·ªÉ qu·∫£n l√Ω th√¥ng tin s√°ch trong h·ªá th·ªëng th∆∞ vi·ªán. Module n√†y cho ph√©p th·ª±c hi·ªán c√°c thao t√°c CRUD tr√™n s√°ch, bao g·ªìm vi·ªác th√™m, s·ª≠a, x√≥a v√† l·∫•y th√¥ng tin s√°ch.

- H·ªó tr·ª£ g√°n "th·ªÉ lo·∫°i ch√≠nh" cho s√°ch qua `main_category_id` (tham chi·∫øu `book_categories`)
- H·ªó tr·ª£ g√°n nhi·ªÅu "kh·ªëi l·ªõp" cho s√°ch qua `grade_level_ids` (quan h·ªá N-N qua `book_grade_levels`)
- **Theo d√µi s·ªë l∆∞·ª£t xem s√°ch** qua tr∆∞·ªùng `view` (m·∫∑c ƒë·ªãnh: 0)
- **API c·∫≠p nh·∫≠t s·ªë l∆∞·ª£t xem** v·ªõi 2 ch·∫ø ƒë·ªô: tƒÉng d·∫ßn (increment) ho·∫∑c ƒë·∫∑t gi√° tr·ªã c·ª• th·ªÉ (set)
- **L·ªçc s√°ch linh ho·∫°t** theo `type`, `main_category_id`, `category_id` trong API l·∫•y danh s√°ch
- **API l·∫•y s√°ch m·ªõi th√™m v√†o** ƒë·ªÉ hi·ªÉn th·ªã c√°c s√°ch m·ªõi nh·∫•t (m·∫∑c ƒë·ªãnh 20 s√°ch)

## üîí Y√™u c·∫ßu x√°c th·ª±c

- **JWT Authentication**: Ch·ªâ c√°c API th√™m/s·ª≠a/x√≥a y√™u c·∫ßu JWT token h·ª£p l·ªá.
- **Public APIs**: C√°c API GET (l·∫•y danh s√°ch, t√¨m ki·∫øm, chi ti·∫øt s√°ch) c√≥ th·ªÉ truy c·∫≠p m√† kh√¥ng c·∫ßn ƒëƒÉng nh·∫≠p.
- **Role Required**: Ch·ªâ user c√≥ role `admin` m·ªõi c√≥ quy·ªÅn th√™m/s·ª≠a/x√≥a.
- **Header**: G·ª≠i k√®m Bearer token trong header cho c√°c API y√™u c·∫ßu x√°c th·ª±c
  ```
  Authorization: Bearer <your_jwt_token>
  ```

## üìã Danh s√°ch API Endpoints

### 1. T·∫°o S√°ch M·ªõi

```http
POST /books
```

- **M√¥ t·∫£**: T·∫°o s√°ch m·ªõi trong h·ªá th·ªëng.
- **Role**: Admin
- **Body**:
  ```json
  {
  	"title": "T√™n s√°ch",
  	"isbn": "1234567890",
  	"publish_year": 2024,
  	"edition": "1st",
  	"description": "M√¥ t·∫£ s√°ch",
  	"cover_image": "url_to_image",
  	"language": "Ti·∫øng Vi·ªát",
  	"page_count": 300,
  	"book_type": "physical",
  	"physical_type": "borrowable",
  	"publisher_id": "uuid_of_publisher",
  	"category_id": "uuid_of_category",
  	"main_category_id": "uuid_of_book_category", // optional
  	"author_ids": ["uuid_of_author_1", "uuid_of_author_2"],
  	"grade_level_ids": ["uuid_grade_1", "uuid_grade_2"] // optional
  }
  ```
- **Response**: 201 - Th√¥ng tin s√°ch ƒë√£ t·∫°o.

### 2. L·∫•y Danh S√°ch S√°ch

```http
GET /books
```

- **M√¥ t·∫£**: L·∫•y danh s√°ch s√°ch c√≥ ph√¢n trang.
- **Query Parameters**:
  - page: S·ªë trang (m·∫∑c ƒë·ªãnh: 1)
  - limit: S·ªë l∆∞·ª£ng m·ªói trang (m·∫∑c ƒë·ªãnh: 10)
  - type: L·ªçc theo lo·∫°i s√°ch (optional)
    - `physical`: Ch·ªâ l·∫•y s√°ch v·∫≠t l√Ω
    - `ebook`: Ch·ªâ l·∫•y s√°ch ƒëi·ªán t·ª≠
  - main_category_id: L·ªçc theo ID th·ªÉ lo·∫°i ch√≠nh (BookCategories) (optional)
  - category_id: L·ªçc theo ID th·ªÉ lo·∫°i (Categories) (optional)
- **Response**: 200 - Danh s√°ch s√°ch v√† th√¥ng tin ph√¢n trang.

### 3. L·∫•y S√°ch M·ªõi Th√™m V√†o

```http
GET /books/latest
```

- **M√¥ t·∫£**: L·∫•y danh s√°ch s√°ch m·ªõi th√™m v√†o h·ªá th·ªëng.
- **Query Parameters**:
  - limit: S·ªë l∆∞·ª£ng s√°ch (m·∫∑c ƒë·ªãnh: 20, t·ªëi ƒëa: 50, t·ªëi thi·ªÉu: 1)
- **Response**: 200 - Danh s√°ch s√°ch m·ªõi th√™m v√†o (s·∫Øp x·∫øp theo th·ªùi gian t·∫°o gi·∫£m d·∫ßn).
- **Validation**: Limit ph·∫£i t·ª´ 1 ƒë·∫øn 50, n·∫øu kh√¥ng h·ª£p l·ªá s·∫Ω tr·∫£ v·ªÅ l·ªói 400.

### 4. T√¨m Ki·∫øm S√°ch

```http
GET /books/search
```

- **M√¥ t·∫£**: T√¨m ki·∫øm s√°ch theo ti√™u ƒë·ªÅ ho·∫∑c m√¥ t·∫£.
- **Query Parameters**:
  - q: T·ª´ kh√≥a t√¨m ki·∫øm
  - page, limit: Th√¥ng tin ph√¢n trang
- **Response**: 200 - K·∫øt qu·∫£ t√¨m ki·∫øm.

### 5. L·∫•y Th√¥ng Tin S√°ch Theo ISBN

```http
GET /books/isbn/:isbn
```

- **M√¥ t·∫£**: L·∫•y th√¥ng tin s√°ch theo ISBN.
- **Response**: 200 - Th√¥ng tin s√°ch.

### 6. L·∫•y Chi Ti·∫øt S√°ch

```http
GET /books/:id
```

- **M√¥ t·∫£**: L·∫•y th√¥ng tin chi ti·∫øt c·ªßa s√°ch theo ID.
- **Response**: 200 - Th√¥ng tin s√°ch.

### 7. L·∫•y Th√¥ng Tin S√°ch Theo Slug

```http
GET /books/slug/:slug
```

- **M√¥ t·∫£**: L·∫•y th√¥ng tin s√°ch theo slug.
- **Response**: 200 - Th√¥ng tin s√°ch.

### 8. C·∫≠p Nh·∫≠t S√°ch Theo ID

```http
PATCH /books/:id
```

- **Role**: Admin
- **Body**: C·∫≠p nh·∫≠t th√¥ng tin s√°ch.
- **Response**: 200 - Th√¥ng tin s√°ch sau khi c·∫≠p nh·∫≠t.

### 9. C·∫≠p Nh·∫≠t S√°ch Theo Slug

```http
PATCH /books/slug/:slug
```

- **Role**: Admin
- **Body**: C·∫≠p nh·∫≠t th√¥ng tin s√°ch.
- **Response**: 200 - Th√¥ng tin s√°ch sau khi c·∫≠p nh·∫≠t.

### 10. X√≥a S√°ch Theo ID

```http
DELETE /books/:id
```

- **Role**: Admin
- **Response**: 204 - X√≥a th√†nh c√¥ng.

### 11. X√≥a S√°ch Theo Slug

```http
DELETE /books/slug/:slug
```

- **Role**: Admin
- **Response**: 204 - X√≥a th√†nh c√¥ng.

### 12. T·∫°o Nhi·ªÅu S√°ch

```http
POST /books/bulk
```

- **M√¥ t·∫£**: T·∫°o nhi·ªÅu s√°ch c√πng l√∫c trong h·ªá th·ªëng.
- **Role**: Admin
- **Body**:
  ```json
  [
  	{
  		"title": "T√™n s√°ch 1",
  		"isbn": "1234567890",
  		"publish_year": 2024,
  		"edition": "1st",
  		"description": "M√¥ t·∫£ s√°ch 1",
  		"cover_image": "url_to_image_1",
  		"language": "Ti·∫øng Vi·ªát",
  		"page_count": 300,
  		"book_type": "physical",
  		"physical_type": "borrowable",
  		"publisher_id": "uuid_of_publisher_1",
  		"category_id": "uuid_of_category_1",
  		"main_category_id": "uuid_of_book_category_1",
  		"author_ids": ["uuid_author_1"],
  		"grade_level_ids": ["uuid_grade_1", "uuid_grade_2"]
  	},
  	{
  		"title": "T√™n s√°ch 2",
  		"isbn": "0987654321",
  		"publish_year": 2024,
  		"edition": "1st",
  		"description": "M√¥ t·∫£ s√°ch 2",
  		"cover_image": "url_to_image_2",
  		"language": "Ti·∫øng Vi·ªát",
  		"page_count": 250,
  		"book_type": "physical",
  		"physical_type": "borrowable",
  		"publisher_id": "uuid_of_publisher_2",
  		"category_id": "uuid_of_category_2",
  		"main_category_id": null,
  		"author_ids": ["uuid_author_2", "uuid_author_3"],
  		"grade_level_ids": []
  	}
  ]
  ```
- **Response**: 201 - Danh s√°ch th√¥ng tin s√°ch ƒë√£ t·∫°o.

### 13. C·∫≠p Nh·∫≠t S·ªë L∆∞·ª£t Xem S√°ch Theo ID

```http
PATCH /books/:id/view
```

- **M√¥ t·∫£**: C·∫≠p nh·∫≠t s·ªë l∆∞·ª£t xem s√°ch theo ID.
- **Body**:
  ```json
  {
  	"type": "increment" // ho·∫∑c "set"
  }
  ```
  ho·∫∑c
  ```json
  {
  	"type": "set",
  	"value": 100
  }
  ```
- **Response**: 200 - Th√¥ng tin s√°ch sau khi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£t xem.

### 14. C·∫≠p Nh·∫≠t S·ªë L∆∞·ª£t Xem S√°ch Theo Slug

```http
PATCH /books/slug/:slug/view
```

- **M√¥ t·∫£**: C·∫≠p nh·∫≠t s·ªë l∆∞·ª£t xem s√°ch theo slug.
- **Body**: T∆∞∆°ng t·ª± nh∆∞ API theo ID.
- **Response**: 200 - Th√¥ng tin s√°ch sau khi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£t xem.

## üìù Validation Rules

### CreateBookDto

- **title**: B·∫Øt bu·ªôc, string, max 255 k√Ω t·ª±.
- **isbn**: B·∫Øt bu·ªôc, string, unique.
- **publish_year**: B·∫Øt bu·ªôc, number.
- **edition**: Optional, string.
- **description**: Optional, string.
- **cover_image**: Optional, string (URL).
- **language**: B·∫Øt bu·ªôc, string.
- **page_count**: B·∫Øt bu·ªôc, number.
- **book_type**: B·∫Øt bu·ªôc, enum (physical, ebook).
- **physical_type**: Optional, enum (library_use, borrowable) ‚Äì ch·ªâ khi `book_type = physical`.
- **publisher_id**: B·∫Øt bu·ªôc, UUID.
- **category_id**: B·∫Øt bu·ªôc, UUID.
- **main_category_id**: Optional, UUID (tham chi·∫øu `book_categories.id`).
- **author_ids**: B·∫Øt bu·ªôc, array UUID.
- **grade_level_ids**: Optional, array UUID (thi·∫øt l·∫≠p mapping v·ªõi `grade_levels`).

## üìä V√≠ d·ª• S·ª≠ d·ª•ng

### 1. T·∫°o S√°ch

```bash
curl -X POST "http://localhost:8002/books" \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "T√™n s√°ch",
    "isbn": "1234567890",
    "publish_year": 2024,
    "edition": "1st",
    "description": "M√¥ t·∫£ s√°ch",
    "cover_image": "url_to_image",
    "language": "Ti·∫øng Vi·ªát",
    "page_count": 300,
    "book_type": "physical",
    "physical_type": "borrowable",
    "publisher_id": "uuid_of_publisher",
    "category_id": "uuid_of_category",
    "main_category_id": "uuid_of_book_category",
    "author_ids": ["uuid_author_1"],
    "grade_level_ids": ["uuid_grade_1", "uuid_grade_2"]
  }'
```

### 2. L·∫•y Danh S√°ch S√°ch

```bash
# L·∫•y t·∫•t c·∫£ s√°ch
curl "http://localhost:8002/books?page=1&limit=10"

# L·∫•y ch·ªâ s√°ch v·∫≠t l√Ω
curl "http://localhost:8002/books?page=1&limit=10&type=physical"

# L·∫•y ch·ªâ s√°ch ƒëi·ªán t·ª≠
curl "http://localhost:8002/books?page=1&limit=10&type=ebook"

# L·ªçc theo th·ªÉ lo·∫°i ch√≠nh
curl "http://localhost:8002/books?page=1&limit=10&main_category_id=550e8400-e29b-41d4-a716-446655440000"

# L·ªçc theo th·ªÉ lo·∫°i
curl "http://localhost:8002/books?page=1&limit=10&category_id=550e8400-e29b-41d4-a716-446655440001"

# K·∫øt h·ª£p nhi·ªÅu filter
curl "http://localhost:8002/books?page=1&limit=10&type=physical&main_category_id=550e8400-e29b-41d4-a716-446655440000&category_id=550e8400-e29b-41d4-a716-446655440001"
```

### 3. L·∫•y S√°ch M·ªõi Th√™m V√†o

```bash
# L·∫•y 20 s√°ch m·ªõi nh·∫•t (m·∫∑c ƒë·ªãnh)
curl "http://localhost:8002/books/latest"

# L·∫•y 10 s√°ch m·ªõi nh·∫•t
curl "http://localhost:8002/books/latest?limit=10"

# L·∫•y 30 s√°ch m·ªõi nh·∫•t
curl "http://localhost:8002/books/latest?limit=30"
```

### 4. T√¨m Ki·∫øm S√°ch

```bash
curl "http://localhost:8002/books/search?q=T√™n s√°ch"
```

### 5. L·∫•y Th√¥ng Tin S√°ch Theo ISBN

```bash
curl "http://localhost:8002/books/isbn/1234567890"
```

### 6. L·∫•y Chi Ti·∫øt S√°ch

```bash
curl "http://localhost:8002/books/{id}"
```

### 7. C·∫≠p Nh·∫≠t S√°ch

```bash
curl -X PATCH "http://localhost:8002/books/{id}" \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "T√™n s√°ch c·∫≠p nh·∫≠t",
    "description": "M√¥ t·∫£ c·∫≠p nh·∫≠t",
    "main_category_id": "uuid_book_category_moi",
    "grade_level_ids": ["uuid_grade_1", "uuid_grade_3"]
  }'
```

### 8. X√≥a S√°ch

```bash
curl -X DELETE "http://localhost:8002/books/{id}" \
  -H "Authorization: Bearer {token}"
```

### 9. T·∫°o Nhi·ªÅu S√°ch

```bash
curl -X POST "http://localhost:8002/books/bulk" \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '[
    {
      "title": "T√™n s√°ch 1",
      "isbn": "1234567890",
      "publish_year": 2024,
      "edition": "1st",
      "description": "M√¥ t·∫£ s√°ch 1",
      "cover_image": "url_to_image_1",
      "language": "Ti·∫øng Vi·ªát",
      "page_count": 300,
      "book_type": "physical",
      "physical_type": "borrowable",
      "publisher_id": "uuid_of_publisher_1",
      "category_id": "uuid_of_category_1",
      "main_category_id": "uuid_of_book_category_1",
      "author_ids": ["uuid_author_1"],
      "grade_level_ids": ["uuid_grade_1", "uuid_grade_2"]
    }
  ]'
```

### 10. C·∫≠p Nh·∫≠t S·ªë L∆∞·ª£t Xem S√°ch

```bash
# TƒÉng s·ªë l∆∞·ª£t xem l√™n 1
curl -X PATCH "http://localhost:8002/books/{id}/view" \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "increment"
  }'

# ƒê·∫∑t s·ªë l∆∞·ª£t xem th√†nh gi√° tr·ªã c·ª• th·ªÉ
curl -X PATCH "http://localhost:8002/books/{id}/view" \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "set",
    "value": 100
  }'

# C·∫≠p nh·∫≠t theo slug
curl -X PATCH "http://localhost:8002/books/slug/{slug}/view" \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "increment"
  }'
```

## üîç Response Format

### BookWithAuthors Response (r√∫t g·ªçn)

```json
{
	"id": "uuid",
	"title": "T√™n s√°ch",
	"isbn": "1234567890",
	"publish_year": 2024,
	"edition": "1st",
	"description": "M√¥ t·∫£ s√°ch",
	"cover_image": "url_to_image",
	"language": "Ti·∫øng Vi·ªát",
	"page_count": 300,
	"book_type": "physical",
	"physical_type": "borrowable",
	"slug": "ten-sach",
	"view": 0,
	"main_category_id": "uuid_of_book_category",
	"authors": [
		{ "id": "author_uuid", "author_name": "T√™n t√°c gi·∫£", "slug": "ten-tac-gia" }
	],
	"createdAt": "2024-01-01T00:00:00.000Z",
	"updatedAt": "2024-01-01T00:00:00.000Z"
}
```

> L∆∞u √Ω: C√°c endpoint chi ti·∫øt c√≥ th·ªÉ tr·∫£ th√™m `mainCategory` (object) n·∫øu ƒë∆∞·ª£c load quan h·ªá.

## ‚ö†Ô∏è L∆∞u √Ω

1. **Authentication**:
   - C√°c API GET (l·∫•y danh s√°ch, t√¨m ki·∫øm, chi ti·∫øt) kh√¥ng y√™u c·∫ßu x√°c th·ª±c
   - C√°c API POST/PATCH/DELETE y√™u c·∫ßu JWT token h·ª£p l·ªá
2. **Authorization**: Ch·ªâ admin m·ªõi c√≥ quy·ªÅn th√™m/s·ª≠a/x√≥a s√°ch
3. **Port**: API ch·∫°y tr√™n port 8002
4. **Response Type**: S·ª≠ d·ª•ng `BookWithAuthorsDto` ƒë·ªÉ tr·∫£ v·ªÅ th√¥ng tin s√°ch k√®m t√°c gi·∫£
5. **Bulk Create**: Endpoint `/books/bulk` cho ph√©p t·∫°o nhi·ªÅu s√°ch c√πng l√∫c
6. **S·ªë l∆∞·ª£t xem**:
   - Tr∆∞·ªùng `view` ƒë∆∞·ª£c kh·ªüi t·∫°o v·ªõi gi√° tr·ªã 0
   - API c·∫≠p nh·∫≠t s·ªë l∆∞·ª£t xem kh√¥ng y√™u c·∫ßu quy·ªÅn admin
   - H·ªó tr·ª£ 2 ch·∫ø ƒë·ªô: `increment` (tƒÉng 1) v√† `set` (ƒë·∫∑t gi√° tr·ªã c·ª• th·ªÉ)
7. **T√≠ch h·ª£p**:
   - `main_category_id` tham chi·∫øu `book_categories`
   - `grade_level_ids` s·∫Ω ƒë∆∞·ª£c ƒë·ªìng b·ªô qua `book_grade_levels` (ghi ƒë√® to√†n b·ªô li√™n k·∫øt hi·ªán c√≥)
