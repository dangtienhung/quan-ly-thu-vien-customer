# Module Qu·∫£n l√Ω Ph·∫°t (Fines)

## üìë T·ªïng quan

Module Qu·∫£n l√Ω Ph·∫°t cung c·∫•p c√°c API ƒë·ªÉ qu·∫£n l√Ω to√†n b·ªô quy tr√¨nh ph·∫°t trong h·ªá th·ªëng th∆∞ vi·ªán. Module n√†y h·ªó tr·ª£ ƒë·∫ßy ƒë·ªß c√°c t√≠nh nƒÉng t·ª´ t·∫°o ph·∫°t t·ª± ƒë·ªông, thanh to√°n, mi·ªÖn ph·∫°t ƒë·∫øn th·ªëng k√™ chi ti·∫øt.

## üîí Y√™u c·∫ßu x√°c th·ª±c

- **JWT Authentication**: T·∫•t c·∫£ API y√™u c·∫ßu JWT token h·ª£p l·ªá
- **Role Required**:
  - Admin: C√≥ quy·ªÅn truy c·∫≠p t·∫•t c·∫£ endpoints
  - Reader: Ch·ªâ c√≥ quy·ªÅn xem th√¥ng tin ph·∫°t c·ªßa m√¨nh
- **Header**: G·ª≠i k√®m Bearer token trong header
  ```
  Authorization: Bearer <your_jwt_token>
  ```

## üîë Quy·ªÅn h·∫°n

- ‚úÖ **ADMIN**: C√≥ quy·ªÅn truy c·∫≠p t·∫•t c·∫£ c√°c endpoints
- ‚úÖ **READER**: Ch·ªâ c√≥ quy·ªÅn xem th√¥ng tin ph·∫°t c·ªßa m√¨nh
- ‚ùå **Kh√°ch**: Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p

## üìã Danh s√°ch API Endpoints

### 1. T·∫°o B·∫£n Ghi Ph·∫°t
```http
POST /fines
```
- **M√¥ t·∫£**: T·∫°o b·∫£n ghi ph·∫°t m·ªõi (ch·ªâ Admin)
- **Body**: CreateFineDto
- **Response**: 201 - Th√¥ng tin b·∫£n ghi ph·∫°t ƒë√£ t·∫°o
- **L·ªói**:
  - 400: D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá
  - 403: Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p

### 2. T·∫°o Ph·∫°t T·ª± ƒê·ªông Cho S√°ch Tr·ªÖ H·∫°n
```http
POST /fines/overdue/:borrowId
```
- **M√¥ t·∫£**: T·∫°o ph·∫°t t·ª± ƒë·ªông cho s√°ch tr·ªÖ h·∫°n (ch·ªâ Admin)
- **Parameters**: borrowId - UUID c·ªßa b·∫£n ghi m∆∞·ª£n s√°ch
- **Body**: { overdueDays: number, dailyRate?: number }
- **Response**: 201 - Th√¥ng tin ph·∫°t tr·ªÖ h·∫°n ƒë√£ t·∫°o
- **L·ªói**:
  - 400: ƒê√£ c√≥ ph·∫°t tr·ªÖ h·∫°n cho b·∫£n ghi n√†y
  - 403: Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p

### 3. L·∫•y Danh S√°ch B·∫£n Ghi Ph·∫°t
```http
GET /fines
```
- **M√¥ t·∫£**: L·∫•y danh s√°ch b·∫£n ghi ph·∫°t c√≥ ph√¢n trang
- **Query Parameters**:
  - page: S·ªë trang (m·∫∑c ƒë·ªãnh: 1)
  - limit: S·ªë l∆∞·ª£ng m·ªói trang (m·∫∑c ƒë·ªãnh: 10)
- **Response**: 200 - Danh s√°ch b·∫£n ghi ph·∫°t v√† th√¥ng tin ph√¢n trang

### 4. T√¨m Ki·∫øm B·∫£n Ghi Ph·∫°t
```http
GET /fines/search
```
- **M√¥ t·∫£**: T√¨m ki·∫øm b·∫£n ghi ph·∫°t theo nhi·ªÅu ti√™u ch√≠
- **Query Parameters**:
  - q: T·ª´ kh√≥a t√¨m ki·∫øm (m√¥ t·∫£, ghi ch√∫, m√£ giao d·ªãch)
  - page: S·ªë trang (m·∫∑c ƒë·ªãnh: 1)
  - limit: S·ªë l∆∞·ª£ng m·ªói trang (m·∫∑c ƒë·ªãnh: 10)
- **Response**: 200 - K·∫øt qu·∫£ t√¨m ki·∫øm c√≥ ph√¢n trang

### 5. L·∫•y Danh S√°ch Theo Tr·∫°ng Th√°i
```http
GET /fines/status/:status
```
- **M√¥ t·∫£**: L·∫•y danh s√°ch b·∫£n ghi ph·∫°t theo tr·∫°ng th√°i
- **Parameters**:
  - status: Tr·∫°ng th√°i (unpaid, paid, partially_paid, waived)
- **Query Parameters**: H·ªó tr·ª£ ph√¢n trang
- **Response**: 200 - Danh s√°ch b·∫£n ghi ph·∫°t theo tr·∫°ng th√°i

### 6. L·∫•y Danh S√°ch Theo Lo·∫°i
```http
GET /fines/type/:type
```
- **M√¥ t·∫£**: L·∫•y danh s√°ch b·∫£n ghi ph·∫°t theo lo·∫°i
- **Parameters**:
  - type: Lo·∫°i ph·∫°t (overdue, damage, lost, administrative)
- **Query Parameters**: H·ªó tr·ª£ ph√¢n trang
- **Response**: 200 - Danh s√°ch b·∫£n ghi ph·∫°t theo lo·∫°i

### 7. L·∫•y Danh S√°ch Theo B·∫£n Ghi M∆∞·ª£n S√°ch
```http
GET /fines/borrow/:borrowId
```
- **M√¥ t·∫£**: L·∫•y danh s√°ch b·∫£n ghi ph·∫°t theo b·∫£n ghi m∆∞·ª£n s√°ch
- **Parameters**:
  - borrowId: UUID c·ªßa b·∫£n ghi m∆∞·ª£n s√°ch
- **Query Parameters**: H·ªó tr·ª£ ph√¢n trang
- **Response**: 200 - Danh s√°ch b·∫£n ghi ph·∫°t theo b·∫£n ghi m∆∞·ª£n s√°ch

### 8. L·∫•y Danh S√°ch Ph·∫°t Qu√° H·∫°n Thanh To√°n
```http
GET /fines/overdue
```
- **M√¥ t·∫£**: L·∫•y danh s√°ch ph·∫°t qu√° h·∫°n thanh to√°n
- **Query Parameters**: H·ªó tr·ª£ ph√¢n trang
- **Response**: 200 - Danh s√°ch ph·∫°t qu√° h·∫°n thanh to√°n

### 9. L·∫•y Th·ªëng K√™ Ph·∫°t
```http
GET /fines/stats
```
- **M√¥ t·∫£**: L·∫•y th·ªëng k√™ t·ªïng quan v·ªÅ ph·∫°t
- **Response**: 200 - Th·ªëng k√™ chi ti·∫øt
  ```json
  {
    "total": 100,
    "unpaid": 30,
    "paid": 60,
    "partially_paid": 5,
    "waived": 5,
    "totalAmount": 5000000,
    "totalPaid": 3000000,
    "totalUnpaid": 2000000,
    "byType": [
      {"type": "overdue", "count": 80, "amount": 4000000},
      {"type": "damage", "count": 20, "amount": 1000000}
    ],
    "byMonth": [
      {"month": "2024-01", "count": 50, "amount": 2500000},
      {"month": "2024-02", "count": 50, "amount": 2500000}
    ]
  }
  ```

### 10. L·∫•y Th√¥ng Tin B·∫£n Ghi Ph·∫°t
```http
GET /fines/:id
```
- **M√¥ t·∫£**: L·∫•y th√¥ng tin chi ti·∫øt b·∫£n ghi ph·∫°t theo ID
- **Response**: 200 - Th√¥ng tin chi ti·∫øt b·∫£n ghi ph·∫°t
- **L·ªói**: 404 - Kh√¥ng t√¨m th·∫•y b·∫£n ghi ph·∫°t

### 11. C·∫≠p Nh·∫≠t B·∫£n Ghi Ph·∫°t
```http
PATCH /fines/:id
```
- **M√¥ t·∫£**: C·∫≠p nh·∫≠t th√¥ng tin b·∫£n ghi ph·∫°t theo ID (ch·ªâ Admin)
- **Body**: UpdateFineDto
- **Response**: 200 - Th√¥ng tin b·∫£n ghi ph·∫°t ƒë√£ c·∫≠p nh·∫≠t
- **L·ªói**:
  - 404: Kh√¥ng t√¨m th·∫•y b·∫£n ghi ph·∫°t
  - 400: D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá
  - 403: Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p

### 12. Thanh To√°n Ph·∫°t
```http
PATCH /fines/:id/pay
```
- **M√¥ t·∫£**: Thanh to√°n ph·∫°t (ch·ªâ Admin)
- **Body**: { amount: number, paymentMethod: string, transactionId?: string }
- **Response**: 200 - Th√¥ng tin b·∫£n ghi sau khi thanh to√°n
- **L·ªói**:
  - 400: Kh√¥ng th·ªÉ thanh to√°n ph·∫°t n√†y
  - 404: Kh√¥ng t√¨m th·∫•y b·∫£n ghi ph·∫°t
  - 403: Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p

### 13. Mi·ªÖn Ph·∫°t
```http
PATCH /fines/:id/waive
```
- **M√¥ t·∫£**: Mi·ªÖn ph·∫°t (ch·ªâ Admin)
- **Body**: { librarianNotes?: string }
- **Response**: 200 - Th√¥ng tin b·∫£n ghi sau khi mi·ªÖn ph·∫°t
- **L·ªói**:
  - 400: Kh√¥ng th·ªÉ mi·ªÖn ph·∫°t n√†y
  - 404: Kh√¥ng t√¨m th·∫•y b·∫£n ghi ph·∫°t
  - 403: Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p

### 14. X√≥a B·∫£n Ghi Ph·∫°t
```http
DELETE /fines/:id
```
- **M√¥ t·∫£**: X√≥a b·∫£n ghi ph·∫°t kh·ªèi h·ªá th·ªëng theo ID (ch·ªâ Admin)
- **Response**: 204 - X√≥a th√†nh c√¥ng
- **L·ªói**:
  - 404: Kh√¥ng t√¨m th·∫•y b·∫£n ghi ph·∫°t
  - 403: Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p

## üìù Validation Rules

### CreateFineDto
- **borrow_id**: B·∫Øt bu·ªôc, UUID h·ª£p l·ªá
- **fine_amount**: B·∫Øt bu·ªôc, s·ªë d∆∞∆°ng
- **paid_amount**: T√πy ch·ªçn, s·ªë kh√¥ng √¢m, kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n fine_amount
- **fine_date**: B·∫Øt bu·ªôc, ƒë·ªãnh d·∫°ng ng√†y h·ª£p l·ªá
- **payment_date**: T√πy ch·ªçn, ƒë·ªãnh d·∫°ng ng√†y h·ª£p l·ªá
- **reason**: B·∫Øt bu·ªôc, enum FineType
- **description**: T√πy ch·ªçn, chu·ªói, t·ªëi ƒëa 1000 k√Ω t·ª±
- **status**: T√πy ch·ªçn, enum FineStatus (t·ª± ƒë·ªông t√≠nh to√°n)
- **overdue_days**: T√πy ch·ªçn, s·ªë nguy√™n t·ª´ 0-365
- **daily_rate**: T√πy ch·ªçn, s·ªë d∆∞∆°ng
- **librarian_notes**: T√πy ch·ªçn, chu·ªói, t·ªëi ƒëa 1000 k√Ω t·ª±
- **reader_notes**: T√πy ch·ªçn, chu·ªói, t·ªëi ƒëa 1000 k√Ω t·ª±
- **due_date**: T√πy ch·ªçn, ƒë·ªãnh d·∫°ng ng√†y h·ª£p l·ªá
- **payment_method**: T√πy ch·ªçn, enum ['cash', 'card', 'bank_transfer', 'online']
- **transaction_id**: T√πy ch·ªçn, chu·ªói, t·ªëi ƒëa 100 k√Ω t·ª±

### UpdateFineDto
- T·∫•t c·∫£ tr∆∞·ªùng l√† kh√¥ng b·∫Øt bu·ªôc
- C√°c quy t·∫Øc validation gi·ªëng CreateFineDto

## üéØ Business Rules

1. **T·∫°o B·∫£n Ghi Ph·∫°t**
   - Ki·ªÉm tra b·∫£n ghi m∆∞·ª£n s√°ch c√≥ t·ªìn t·∫°i kh√¥ng
   - S·ªë ti·ªÅn ƒë√£ thanh to√°n kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n s·ªë ti·ªÅn ph·∫°t
   - T·ª± ƒë·ªông t√≠nh to√°n tr·∫°ng th√°i d·ª±a tr√™n s·ªë ti·ªÅn ƒë√£ thanh to√°n

2. **T·∫°o Ph·∫°t T·ª± ƒê·ªông Tr·ªÖ H·∫°n**
   - Ki·ªÉm tra ch∆∞a c√≥ ph·∫°t tr·ªÖ h·∫°n cho b·∫£n ghi m∆∞·ª£n s√°ch
   - T·ª± ƒë·ªông t√≠nh s·ªë ti·ªÅn ph·∫°t = s·ªë ng√†y tr·ªÖ √ó m·ª©c ph·∫°t m·ªói ng√†y
   - T·ª± ƒë·ªông set h·∫°n thanh to√°n 30 ng√†y

3. **Thanh To√°n Ph·∫°t**
   - Ch·ªâ c√≥ th·ªÉ thanh to√°n ph·∫°t ch∆∞a thanh to√°n ƒë·∫ßy ƒë·ªß
   - Kh√¥ng th·ªÉ thanh to√°n ph·∫°t ƒë√£ ƒë∆∞·ª£c mi·ªÖn
   - S·ªë ti·ªÅn thanh to√°n kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° s·ªë ti·ªÅn ph·∫°t c√≤n l·∫°i
   - T·ª± ƒë·ªông c·∫≠p nh·∫≠t tr·∫°ng th√°i sau khi thanh to√°n

4. **Mi·ªÖn Ph·∫°t**
   - Ch·ªâ c√≥ th·ªÉ mi·ªÖn ph·∫°t ch∆∞a thanh to√°n ƒë·∫ßy ƒë·ªß
   - Kh√¥ng th·ªÉ mi·ªÖn ph·∫°t ƒë√£ thanh to√°n
   - C√≥ th·ªÉ th√™m ghi ch√∫ l√Ω do mi·ªÖn ph·∫°t

5. **Qu·∫£n L√Ω Tr·∫°ng Th√°i**
   - unpaid: Ch∆∞a thanh to√°n
   - paid: ƒê√£ thanh to√°n ƒë·∫ßy ƒë·ªß
   - partially_paid: Thanh to√°n m·ªôt ph·∫ßn
   - waived: ƒê∆∞·ª£c mi·ªÖn

6. **Lo·∫°i Ph·∫°t**
   - overdue: Ph·∫°t tr·ªÖ h·∫°n
   - damage: Ph·∫°t h∆∞ h·ªèng s√°ch
   - lost: Ph·∫°t m·∫•t s√°ch
   - administrative: Ph·∫°t h√†nh ch√≠nh

## üìä Monitoring

- Theo d√µi s·ªë l∆∞·ª£ng ph·∫°t theo tr·∫°ng th√°i
- Th·ªëng k√™ ph·∫°t theo lo·∫°i v√† theo th√°ng
- Monitoring ph·∫°t qu√° h·∫°n thanh to√°n
- Theo d√µi t·ªïng thu ph·∫°t v√† t·ª∑ l·ªá thu h·ªìi

## üîç T√≠nh nƒÉng T√¨m ki·∫øm

### T√¨m ki·∫øm c∆° b·∫£n
- T√¨m theo m√¥ t·∫£ ph·∫°t
- T√¨m theo ghi ch√∫ th·ªß th∆∞
- T√¨m theo ghi ch√∫ ƒë·ªôc gi·∫£
- T√¨m theo m√£ giao d·ªãch thanh to√°n

### L·ªçc d·ªØ li·ªáu
- L·ªçc theo tr·∫°ng th√°i ph·∫°t
- L·ªçc theo lo·∫°i ph·∫°t
- L·ªçc theo b·∫£n ghi m∆∞·ª£n s√°ch
- L·ªçc ph·∫°t qu√° h·∫°n thanh to√°n
- S·∫Øp x·∫øp theo ng√†y t·∫°o (m·ªõi nh·∫•t)

## üöÄ T·ªëi ∆∞u h√≥a

### Database Indexes
- Index tr√™n borrow_id ƒë·ªÉ t√¨m ki·∫øm theo b·∫£n ghi m∆∞·ª£n s√°ch
- Index tr√™n status ƒë·ªÉ l·ªçc tr·∫°ng th√°i
- Index tr√™n reason ƒë·ªÉ l·ªçc lo·∫°i ph·∫°t
- Index tr√™n fine_date ƒë·ªÉ s·∫Øp x·∫øp theo ng√†y ph·∫°t
- Index tr√™n due_date ƒë·ªÉ t√¨m ph·∫°t qu√° h·∫°n
- Index tr√™n created_at ƒë·ªÉ s·∫Øp x·∫øp

### Performance Tips
- S·ª≠ d·ª•ng pagination cho t·∫•t c·∫£ danh s√°ch
- Cache th·ªëng k√™ ƒë·ªÉ gi·∫£m t·∫£i database
- Optimize query v·ªõi proper indexing
- S·ª≠ d·ª•ng relations ƒë·ªÉ load d·ªØ li·ªáu li√™n quan

## üìà T∆∞∆°ng lai

### T√≠nh nƒÉng m·ªü r·ªông
- T√≠ch h·ª£p v·ªõi h·ªá th·ªëng payment gateway
- T·ª± ƒë·ªông g·ª≠i th√¥ng b√°o ph·∫°t
- Workflow approval cho mi·ªÖn ph·∫°t
- B√°o c√°o chi ti·∫øt theo th·ªùi gian

### T√≠ch h·ª£p
- K·∫øt n·ªëi v·ªõi module BorrowRecords
- K·∫øt n·ªëi v·ªõi module Users (librarian)
- B√°o c√°o th·ªëng k√™ n√¢ng cao
- Audit trail cho c√°c thay ƒë·ªïi

## üîß T√≠nh nƒÉng ƒê·∫∑c bi·ªát

### T·ª± ƒë·ªông t√≠nh to√°n tr·∫°ng th√°i
```typescript
// T·ª± ƒë·ªông c·∫≠p nh·∫≠t tr·∫°ng th√°i d·ª±a tr√™n s·ªë ti·ªÅn ƒë√£ thanh to√°n:
// - paid_amount >= fine_amount ‚Üí PAID
// - paid_amount > 0 ‚Üí PARTIALLY_PAID
// - paid_amount = 0 ‚Üí UNPAID
```

### Ph·∫°t tr·ªÖ h·∫°n t·ª± ƒë·ªông
```typescript
// T·ª± ƒë·ªông t·∫°o ph·∫°t tr·ªÖ h·∫°n:
// - T√≠nh s·ªë ti·ªÅn = s·ªë ng√†y tr·ªÖ √ó m·ª©c ph·∫°t m·ªói ng√†y
// - Set h·∫°n thanh to√°n 30 ng√†y
// - Ki·ªÉm tra tr√πng l·∫∑p ph·∫°t tr·ªÖ h·∫°n
```

### Thanh to√°n linh ho·∫°t
- H·ªó tr·ª£ thanh to√°n t·ª´ng ph·∫ßn
- Nhi·ªÅu ph∆∞∆°ng th·ª©c thanh to√°n
- Tracking m√£ giao d·ªãch
- T·ª± ƒë·ªông c·∫≠p nh·∫≠t tr·∫°ng th√°i

## üìû H·ªó tr·ª£ & B·∫£o tr√¨

**T√≠nh nƒÉng ch√≠nh ƒë√£ tri·ªÉn khai:**
1. ‚úÖ CRUD operations cho b·∫£n ghi ph·∫°t
2. ‚úÖ T·∫°o ph·∫°t t·ª± ƒë·ªông tr·ªÖ h·∫°n
3. ‚úÖ Qu·∫£n l√Ω tr·∫°ng th√°i ph·∫°t
4. ‚úÖ Ch·ª©c nƒÉng thanh to√°n v√† mi·ªÖn ph·∫°t
5. ‚úÖ T√¨m ki·∫øm v√† l·ªçc d·ªØ li·ªáu
6. ‚úÖ Th·ªëng k√™ chi ti·∫øt
7. ‚úÖ T√≠ch h·ª£p v·ªõi BorrowRecords
8. ‚úÖ Swagger documentation ti·∫øng Vi·ªát
9. ‚úÖ Role-based access control

**Access Points:**
- Swagger UI: `http://localhost:8000/api`
- Base URL: `/fines`
- Authentication: JWT Bearer Token

**H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng:**
- T·∫°o ph·∫°t: POST /fines
- T·∫°o ph·∫°t tr·ªÖ h·∫°n: POST /fines/overdue/:borrowId
- Thanh to√°n ph·∫°t: PATCH /fines/:id/pay
- Mi·ªÖn ph·∫°t: PATCH /fines/:id/waive
- Xem th·ªëng k√™: GET /fines/stats